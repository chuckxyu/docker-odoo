#!/bin/bash

# This program patches the configuration for Odoo and then runs the server

# Set some running config options
if [ -f /etc/initrc ]
then 
. /etc/initrc
fi


conf=/etc/odoo/openerp-server.conf
odoo="cd /opt/odoo;$ODOO_SERVER --config $conf"

# Ensure proper content for $UNACCENT
if [ "$UNACCENT" != "True" ]; then
    UNACCENT=False
fi

echo Patching configuration > /dev/stderr


addons=$(ls -1bd /usr/local/lib/python2.7/dist-packages/openerp/addons \
                 /mnt/extra-addons/* | tr '\n' ',' | sed s/,$//)

echo "
[options]
; Configuration file generated by $(readlink --canonicalize $0)
; Database for domain gestion.oondeo.es is gestion-oondeo-es
dbfilter= %h 
proxy_mode = true
workers=${ODOO_WORKERS:=6}
addons_path = " $addons "
;unaccent = $UNACCENT
db_host = ${POSTGRES_HOST:=postgres}
db_port = ${POSTGRES_PORT:=5432}
db_user = ${POSTGRES_USER:=postgres}
db_password = ${POSTGRES_PASSWORD:=postgres}
admin_passwd = ${ADMIN_PASSWORD:=admin}" > $conf

# If database is available, use it
if [ "$DATABASE" != "" ]; then
    echo "database = $DATABASE" >> $conf
fi


# TODO Remove when fixed
echo Applying workaround for https://github.com/docker/docker/issues/20240
ls -R /var/lib/odoo > /dev/null


# Run server
echo Executing \'$odoo\' > /dev/stderr
su odoo --command "$odoo"