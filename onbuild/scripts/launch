#!/bin/sh

# This program patches the configuration for Odoo and then runs the server

# Set some running config options
#set XDG_DATA_HOME for module install
#export XDG_DATA_HOME=/var/lib/odoo/Odoo/addons/$ODOO_VERSION

if [ -f /etc/skel/initrc ]
then
. /etc/skel/initrc
fi
if [ -f ~/.bashrc ]
then
. ~/.bashrc
fi

if [ -n ${TZ} ]; then
  rm /etc/localtime
  ln -sf /usr/share/zoneinfo/${TZ}  /etc/localtime
fi

conf=/etc/odoo/openerp-server.conf
odoo="cd $ODOO_HOME;$ODOO_SERVER --config $conf"

# Ensure proper content for $UNACCENT
if [ "$UNACCENT" != "False" ]; then
    UNACCENT=True
fi

mkdir -p $XDG_DATA_HOME/Odoo/addons/$ODOO_VERSION $XDG_DATA_HOME/addons $XDG_DATA_HOME/.cache $HOME/.cache
addons=$(ls -1d /usr/local/lib/python2.7/dist-packages/openerp/addons $ODOO_ADDONS_HOME/* \
  /mnt/extra-addons-src/* /mnt/extra-addons $XDG_DATA_HOME/addons \
  $XDG_DATA_HOME/Odoo/addons/$ODOO_VERSION $ODOO_HOME/openerp/addons \
  $ODOO_HOME/addons $ODOO_HOME/odoo/addons | tr '\n' ',' | sed s/,$//)

if [ ! -f /etc/odoo/openerp-server.conf ]
then
echo Patching configuration > /dev/stderr


chown -R odoo $XDG_DATA_HOME
chown -R odoo $XDG_DATA_HOME/.local
chown -R odoo $XDG_DATA_HOME/.cache
chown -R odoo $HOME/.cache

echo "
[options]
; Configuration file generated by launch
; Database for domain gestion.oondeo.es is gestion-oondeo-es
xmlrpc_port = 8069
longpolling_port = 8072
dbfilter= ^%h$
proxy_mode = true
workers=${ODOO_WORKERS:=6}
limit_time_real = 3600
limit_time_cpu = 3600
addons_path = " $addons "
unaccent = $UNACCENT
;log_level = debug_sql ['debug_rpc_answer', 'debug_rpc', 'debug', 'debug_sql', 'info', 'warn', 'error', 'critical']
log_level = warn
log_handler = werkzeug:ERROR,openerp.netsvc.rpc.response:ERROR
;auto_reload = True

db_host = ${POSTGRES_HOST:=postgres}
db_port = ${POSTGRES_PORT:=5432}
db_user = ${POSTGRES_USER:=postgres}
db_password = ${POSTGRES_PASSWORD:=postgres}
admin_passwd = ${ADMIN_PASSWORD:=admin}" > $conf

# If database is available, use it
if [ "$DATABASE" != "" ]; then
    echo "database = $DATABASE" >> $conf
fi

fi

sed -i "s|^addons_path.*|addons_path = $addons|g" /etc/odoo/openerp-server.conf
#prevent running problems as user odoo
chown -R odoo /opt
chmod 777 -R /opt
IFS=$','
for adir in $addons
do
  cd $adir
  chown -R odoo $adir/*
  chmod 777 -R $adir/*
done
unset IFS

#Debug: for model in self.models.itervalues():
# Run server
while true
do
  echo Executing \'$odoo\' > /dev/stderr
  PYTHONDONTWRITEBYTECODE=False su odoo -p -c "$odoo"
done
