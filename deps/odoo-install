#!/bin/bash

# This program patches the configuration for Odoo and then runs the server

# Set some running config options
#set XDG_DATA_HOME for module install
#export XDG_DATA_HOME=/var/lib/odoo/Odoo/addons/$ODOO_VERSION

function download {
    url=$1
    branch="$ODOO_VERSION"
    rm -rf /tmp/module
    mkdir -p /tmp/module
    cd /tmp/module
    echo "Downloading $url"
    #git repo download with git
    IFS=':' read -ra ADDR <<< "$url"
    repo="${ADDR[0]}:${ADDR[1]}"
    if [[ "${repo:0:3}" == "git" || "${repo:0:3}" == "ssh" || "${repo:${#repo}-3:${#repo}}" == "git" ]]
    then
        echo "GIT: ${ADDR[*]}"
        if [ "${#ADDR[@]}" == "2" ];then
            branch="${ADDR[1]}"
            git clone --depth 1 -b $branch "$repo" || true
        else
            git clone --depth 1 "$repo" || true
        fi
        mv "$(ls -1bd *)" "$(ls -1bd *)-$branch"
    else
        echo "Download using curl"
        curl --location -o module.zip "$url" && unzip -q ./module.zip -d . && rm module.zip
    fi
    #instalamos las dependencias de los modulos
    ADDON=$(ls -1bd *)
    echo "Instalando $ADDON"
    if [ ! -d $ODOO_ADDONS_HOME/$ADDON ]; then
        echo "Procesando $ADDON"
        mv $ADDON $ODOO_ADDONS_HOME/
        if [ -f $ODOO_ADDONS_HOME/$ADDON/oca_dependencies.txt ]; then
            sed -i '/^[[:blank:]]*#/d;s/#.*//' $ODOO_ADDONS_HOME/$ADDON/oca_dependencies.txt
            sed -i '/^$/d' $ODOO_ADDONS_HOME/$ADDON/oca_dependencies.txt
            while read -u 10 rawline; do
                IFS=' ' read -ra ARRLINE <<< "$rawline"
                if [ "${#ADDR[@]}" == "1" ]; then
                    line="${OCA_URL}/${rawline}.git:$branch"
                else
                    if  [ ${#ADDR[@]} -gt 2 ]; then
                        branch="${ARRLINE[2]}"
                    fi
                    repo=${ARRLINE[1]}
                    if [[ "${repo:0:3}" == "git" || "${repo:0:3}" == "ssh" || "${repo:${#repo}-3:${#repo}}" == "git" ]]; then
                        line="${ARRLINE[1]}:$branch"
                    else
                        line="${ARRLINE[1]}.git:$branch"
                    fi
                fi
                download $line
            done 10<$ODOO_ADDONS_HOME/$ADDON/oca_dependencies.txt

        fi
        if [ -f $ODOO_ADDONS_HOME/$ADDON/requirements.txt ]; then
            $PIP_BIN install -r $ODOO_ADDONS_HOME/$ADDON/requirements.txt || true
        fi
        cd $ODOO_ADDONS_HOME/$ADDON
        make || $PYTHON_BIN  -m compileall . || true
        cd -

    fi
}

cd /tmp
if [ ! -f $ODOO_HOME/odoo.py ]; then
    curl --location --remote-name "$ODOO_URL" && \
    unzip -q ./$ODOO_VERSION.zip -d ./ && \
    mv OCB-$ODOO_VERSION/* $ODOO_HOME && rm -rf OCB-$ODOO_VERSION
    $PIP_BIN install -r $ODOO_HOME/requirements.txt
    cd $ODOO_HOME
    $PYTHON_BIN setup.py develop && make && $PYTHON_BIN  -m compileall .
fi
#OLDIFS=$IFS
#IFS=$'\n'
for url in $ODOO_MODULES
do
    download "$url"
done
rm -rf ~/.cache /tmp/*
